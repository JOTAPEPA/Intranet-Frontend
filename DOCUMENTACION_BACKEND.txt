â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            DOCUMENTACIÃ“N DEL BACKEND - INTRANET
                               Sistema de GestiÃ³n de Departamentos
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ ÃNDICE
---------
1. ARQUITECTURA GENERAL
2. CONFIGURACIÃ“N Y DEPENDENCIAS
3. ESTRUCTURA DE ARCHIVOS
4. ENDPOINTS DISPONIBLES
5. MODELOS DE DATOS
6. SUBIDA DE ARCHIVOS CON CLOUDINARY
7. AUTENTICACIÃ“N Y MIDDLEWARE
8. EJEMPLOS DE PETICIONES
9. MANEJO DE ERRORES
10. GUÃA DE SOLUCIÃ“N DE PROBLEMAS

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ARQUITECTURA GENERAL
========================

El backend estÃ¡ construido con:
- Node.js + Express.js (Servidor web)
- MongoDB + Mongoose (Base de datos)
- Cloudinary (Almacenamiento de archivos en la nube)
- Multer (Manejo de archivos multipart)
- JWT (AutenticaciÃ³n)
- CORS (Cross-Origin Resource Sharing)

PatrÃ³n de arquitectura: MVC (Modelo-Vista-Controlador)
- Modelos: Esquemas de MongoDB/Mongoose
- Vistas: Respuestas JSON (API REST)
- Controladores: LÃ³gica de negocio

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

2. CONFIGURACIÃ“N Y DEPENDENCIAS
================================

VARIABLES DE ENTORNO (.env):
-----------------------------
MONGO_URI = mongodb+srv://[usuario]:[password]@[cluster].mongodb.net/[database]
JWT_SECRET = [tu_clave_secreta_jwt]
PORT = 5000
CLOUDINARY_CLOUD_NAME = [tu_cloud_name]
CLOUDINARY_API_KEY = [tu_api_key]
CLOUDINARY_API_SECRET = [tu_api_secret]

DEPENDENCIAS PRINCIPALES:
-------------------------
- express: Framework web para Node.js
- mongoose: ODM para MongoDB
- cors: Middleware para CORS
- dotenv: Carga variables de entorno
- bcrypt: EncriptaciÃ³n de contraseÃ±as
- jsonwebtoken: Manejo de tokens JWT
- multer: Middleware para archivos multipart
- cloudinary: SDK para Cloudinary

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

3. ESTRUCTURA DE ARCHIVOS
==========================

Back-intranet/
â”œâ”€â”€ main.js                    # Archivo principal del servidor
â”œâ”€â”€ package.json               # Dependencias y scripts
â”œâ”€â”€ .env                      # Variables de entorno
â”œâ”€â”€ config/
â”‚   â””â”€â”€ cloudinary.js         # ConfiguraciÃ³n de Cloudinary
â”œâ”€â”€ models/                   # Esquemas de MongoDB
â”‚   â”œâ”€â”€ user.js               # Modelo de usuarios
â”‚   â”œâ”€â”€ compras.js            # Modelo de compras
â”‚   â”œâ”€â”€ contabilidad.js       # Modelo de contabilidad
â”‚   â”œâ”€â”€ controlInterno.js     # Modelo de control interno
â”‚   â”œâ”€â”€ credito.js            # Modelo de crÃ©dito
â”‚   â”œâ”€â”€ gerencia.js           # Modelo de gerencia
â”‚   â”œâ”€â”€ riesgos.js            # Modelo de riesgos
â”‚   â”œâ”€â”€ talentoHumano.js      # Modelo de talento humano
â”‚   â””â”€â”€ tesoreria.js          # Modelo de tesorerÃ­a
â”œâ”€â”€ controllers/              # LÃ³gica de negocio
â”‚   â”œâ”€â”€ user.js               # Controlador de usuarios
â”‚   â”œâ”€â”€ compras.js            # Controlador de compras
â”‚   â”œâ”€â”€ contabilidad.js       # Controlador de contabilidad
â”‚   â”œâ”€â”€ controlInterno.js     # Controlador de control interno
â”‚   â”œâ”€â”€ credito.js            # Controlador de crÃ©dito
â”‚   â”œâ”€â”€ gerencia.js           # Controlador de gerencia
â”‚   â”œâ”€â”€ riesgos.js            # Controlador de riesgos
â”‚   â”œâ”€â”€ talentoHumano.js      # Controlador de talento humano
â”‚   â””â”€â”€ tesoreria.js          # Controlador de tesorerÃ­a
â”œâ”€â”€ routes/                   # DefiniciÃ³n de rutas
â”‚   â”œâ”€â”€ user.js               # Rutas de usuarios
â”‚   â”œâ”€â”€ compras.js            # Rutas de compras
â”‚   â”œâ”€â”€ contabilidad.js       # Rutas de contabilidad
â”‚   â”œâ”€â”€ controlInterno.js     # Rutas de control interno
â”‚   â”œâ”€â”€ credito.js            # Rutas de crÃ©dito
â”‚   â”œâ”€â”€ gerencia.js           # Rutas de gerencia
â”‚   â”œâ”€â”€ riesgos.js            # Rutas de riesgos
â”‚   â”œâ”€â”€ talentoHumano.js      # Rutas de talento humano
â”‚   â””â”€â”€ tesoreria.js          # Rutas de tesorerÃ­a
â”œâ”€â”€ Middlewares/
â”‚   â”œâ”€â”€ uploadMiddleware.js   # ConfiguraciÃ³n de Multer
â”‚   â””â”€â”€ validarJWT.js         # Middleware de autenticaciÃ³n
â””â”€â”€ utils/
    â””â”€â”€ cloudinaryUtils.js    # Utilidades para Cloudinary

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

4. ENDPOINTS DISPONIBLES
=========================

BASE URL: http://localhost:5000/api

AUTENTICACIÃ“N:
--------------
POST /user/login              # Iniciar sesiÃ³n
POST /user/register           # Registrar usuario

DEPARTAMENTOS (PatrÃ³n idÃ©ntico para todos):
--------------------------------------------
Departamentos disponibles:
- compras
- contabilidad  
- control-interno
- credito
- gerencia
- riesgos
- talento-humano
- tesoreria

Para cada departamento:
POST   /api/{departamento}           # Crear registro con archivos
GET    /api/{departamento}           # Obtener todos los registros
GET    /api/{departamento}/:id       # Obtener registro especÃ­fico
DELETE /api/{departamento}/:id       # Eliminar registro y archivos

EJEMPLOS DE URLs:
-----------------
POST   http://localhost:5000/api/compras
GET    http://localhost:5000/api/contabilidad
GET    http://localhost:5000/api/control-interno/60a7b8c9d8f4a123456789ab
DELETE http://localhost:5000/api/gerencia/60a7b8c9d8f4a123456789ab

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

5. MODELOS DE DATOS
====================

ESQUEMA BASE PARA TODOS LOS DEPARTAMENTOS:
-------------------------------------------
{
  documento: {
    type: String,
    required: true,
    maxlength: 500
  },
  documentos: [{
    url: {
      type: String,
      required: true
    },
    public_id: {
      type: String,
      required: true
    },
    originalName: {
      type: String,
      required: true
    },
    format: String,
    bytes: Number,
    uploadDate: {
      type: Date,
      default: Date.now
    }
  }]
}

MODELO DE USUARIO:
------------------
{
  name: String (requerido),
  email: String (requerido, Ãºnico),
  password: String (requerido, encriptado),
  role: String (requerido, por defecto: "user")
}

EJEMPLO DE REGISTRO COMPLETO:
-----------------------------
{
  "_id": "60a7b8c9d8f4a123456789ab",
  "documento": "Solicitud de compra #12345",
  "documentos": [
    {
      "url": "https://res.cloudinary.com/dvqn0avdc/image/upload/v1625123456/compras/abc123.pdf",
      "public_id": "compras/abc123",
      "originalName": "solicitud_compra.pdf",
      "format": "pdf",
      "bytes": 245760,
      "uploadDate": "2023-09-11T10:30:00.000Z"
    }
  ],
  "createdAt": "2023-09-11T10:30:00.000Z",
  "updatedAt": "2023-09-11T10:30:00.000Z"
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

6. SUBIDA DE ARCHIVOS CON CLOUDINARY
=====================================

CONFIGURACIÃ“N DE MULTER:
-------------------------
- MÃ¡ximo 10 archivos por peticiÃ³n
- TamaÃ±o mÃ¡ximo por archivo: 10MB
- Tipos permitidos: PDF, DOC, DOCX, JPG, JPEG, PNG
- Almacenamiento en memoria (buffer)

ORGANIZACIÃ“N EN CLOUDINARY:
---------------------------
Estructura de carpetas:
cloudinary_cloud/
â”œâ”€â”€ compras/
â”œâ”€â”€ contabilidad/
â”œâ”€â”€ control-interno/
â”œâ”€â”€ credito/
â”œâ”€â”€ gerencia/
â”œâ”€â”€ riesgos/
â”œâ”€â”€ talento-humano/
â””â”€â”€ tesoreria/

PROCESO DE SUBIDA:
------------------
1. Cliente envÃ­a FormData con archivos
2. Multer procesa archivos y los guarda en memoria
3. Servidor valida archivos (tipo, tamaÃ±o)
4. Archivos se suben a Cloudinary en paralelo
5. URLs y metadatos se guardan en MongoDB
6. Respuesta con URLs pÃºblicos de Cloudinary

METADATOS GUARDADOS:
--------------------
- url: URL pÃºblico del archivo en Cloudinary
- public_id: ID Ãºnico en Cloudinary (para eliminaciÃ³n)
- originalName: Nombre original del archivo
- format: ExtensiÃ³n del archivo
- bytes: TamaÃ±o en bytes
- uploadDate: Fecha de subida

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

7. AUTENTICACIÃ“N Y MIDDLEWARE
==============================

MIDDLEWARE DE VALIDACIÃ“N JWT:
------------------------------
- Verifica token en header Authorization
- Formato: "Bearer [token]"
- Decodifica y valida token
- Agrega informaciÃ³n del usuario a req.user

MIDDLEWARE DE SUBIDA DE ARCHIVOS:
---------------------------------
- Multer configurado para manejar multipart/form-data
- ValidaciÃ³n de tipos de archivo
- LimitaciÃ³n de tamaÃ±o
- Manejo de errores especÃ­ficos

MIDDLEWARE DE ERRORES GLOBALES:
-------------------------------
- Captura errores no manejados
- Formato consistente de respuestas de error
- Logging de errores para debugging

CONFIGURACIÃ“N CORS:
-------------------
OrÃ­genes permitidos:
- http://localhost:5173 (Frontend en desarrollo)
- http://localhost:5174 (Frontend alternativo)
- null (Para archivos locales)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

8. EJEMPLOS DE PETICIONES
==========================

CREAR REGISTRO CON ARCHIVOS (POST):
------------------------------------
URL: POST http://localhost:5000/api/compras
Headers: Content-Type: multipart/form-data

FormData:
- documento: "Solicitud de compra de equipos"
- documentos: [archivo1.pdf, archivo2.jpg] (archivos binarios)

Respuesta exitosa (201):
{
  "message": "Compra creado exitosamente",
  "data": {
    "_id": "60a7b8c9d8f4a123456789ab",
    "documento": "Solicitud de compra de equipos",
    "documentos": [
      {
        "url": "https://res.cloudinary.com/dvqn0avdc/image/upload/v1625123456/compras/abc123.pdf",
        "public_id": "compras/abc123",
        "originalName": "archivo1.pdf",
        "format": "pdf",
        "bytes": 245760,
        "uploadDate": "2023-09-11T10:30:00.000Z"
      }
    ],
    "createdAt": "2023-09-11T10:30:00.000Z"
  }
}

OBTENER TODOS LOS REGISTROS (GET):
----------------------------------
URL: GET http://localhost:5000/api/compras
Headers: Content-Type: application/json

Respuesta exitosa (200):
{
  "message": "Compras obtenidos exitosamente",
  "data": [
    {
      "_id": "60a7b8c9d8f4a123456789ab",
      "documento": "Solicitud de compra de equipos",
      "documentos": [...],
      "createdAt": "2023-09-11T10:30:00.000Z"
    }
  ]
}

OBTENER REGISTRO ESPECÃFICO (GET):
----------------------------------
URL: GET http://localhost:5000/api/compras/60a7b8c9d8f4a123456789ab
Headers: Content-Type: application/json

Respuesta exitosa (200):
{
  "message": "Compra obtenido exitosamente",
  "data": {
    "_id": "60a7b8c9d8f4a123456789ab",
    "documento": "Solicitud de compra de equipos",
    "documentos": [...],
    "createdAt": "2023-09-11T10:30:00.000Z"
  }
}

ELIMINAR REGISTRO (DELETE):
---------------------------
URL: DELETE http://localhost:5000/api/compras/60a7b8c9d8f4a123456789ab
Headers: Content-Type: application/json

Respuesta exitosa (200):
{
  "message": "Compra eliminado exitosamente"
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

9. MANEJO DE ERRORES
=====================

CÃ“DIGOS DE ESTADO HTTP:
------------------------
200 - OK: OperaciÃ³n exitosa
201 - Created: Recurso creado exitosamente
400 - Bad Request: Error en los datos enviados
401 - Unauthorized: No autorizado
404 - Not Found: Recurso no encontrado
500 - Internal Server Error: Error interno del servidor

TIPOS DE ERRORES COMUNES:
--------------------------

ERROR DE ARCHIVO DEMASIADO GRANDE:
{
  "message": "El archivo es demasiado grande",
  "error": "File too large",
  "code": "LIMIT_FILE_SIZE"
}

ERROR DE TIPO DE ARCHIVO NO PERMITIDO:
{
  "message": "Tipo de archivo no permitido", 
  "error": "Invalid file type"
}

ERROR DE CONEXIÃ“N A MONGODB:
{
  "message": "Error interno del servidor",
  "error": "Database connection failed"
}

ERROR DE CLOUDINARY:
{
  "message": "Error subiendo archivo a Cloudinary",
  "error": "Cloudinary upload failed"
}

ERROR DE REGISTRO NO ENCONTRADO:
{
  "message": "Compra no encontrado",
  "error": "Record not found"
}

VALIDACIÃ“N DE MULTER:
---------------------
- LIMIT_FILE_SIZE: Archivo demasiado grande (>10MB)
- LIMIT_FILE_COUNT: Demasiados archivos (>10)
- LIMIT_UNEXPECTED_FILE: Campo de archivo inesperado
- Invalid file type: Tipo de archivo no permitido

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

10. GUÃA DE SOLUCIÃ“N DE PROBLEMAS
==================================

PROBLEMA: PUERTO EN USO (EADDRINUSE)
-------------------------------------
Error: "listen EADDRINUSE: address already in use :::5000"

Soluciones:
1. Matar procesos de Node.js: taskkill /f /im node.exe
2. Verificar puerto: netstat -ano | findstr ":5000"
3. Usar script de limpieza: start-clean.bat

PROBLEMA: CORS BLOQUEADO
------------------------
Error: "Access to XMLHttpRequest blocked by CORS policy"

Soluciones:
1. Verificar que el origen estÃ© en la lista de CORS permitidos
2. Actualizar configuraciÃ³n CORS en main.js
3. Reiniciar servidor despuÃ©s de cambios

PROBLEMA: ARCHIVOS NO SUBEN
---------------------------
Posibles causas:
1. Tipo de archivo no permitido
2. Archivo demasiado grande (>10MB)
3. Campo incorrecto (debe ser 'documentos')
4. Content-Type incorrecto (debe ser multipart/form-data)

PROBLEMA: ERROR DE CLOUDINARY
-----------------------------
Verificar:
1. Variables de entorno de Cloudinary
2. ConexiÃ³n a internet
3. LÃ­mites de cuenta de Cloudinary
4. ConfiguraciÃ³n en config/cloudinary.js

PROBLEMA: BASE DE DATOS NO CONECTA
----------------------------------
Verificar:
1. Variable MONGO_URI en .env
2. ConexiÃ³n a internet
3. Permisos de IP en MongoDB Atlas
4. Credenciales correctas

COMANDOS ÃšTILES PARA DEBUG:
---------------------------
# Verificar procesos de Node.js
tasklist | findstr node.exe

# Verificar puerto 5000
netstat -ano | findstr ":5000"

# Matar todos los procesos de Node.js
taskkill /f /im node.exe

# Iniciar servidor con logs detallados
node --trace-warnings main.js

# Verificar variables de entorno
node -e "require('dotenv').config(); console.log(process.env.PORT, process.env.MONGO_URI ? 'DB_SET' : 'DB_NOT_SET')"

ESTRUCTURA DE LOGS:
-------------------
El servidor muestra logs detallados:
- ğŸš€ Inicio del servidor
- âœ… ConexiÃ³n exitosa a MongoDB
- ğŸ”¥ Peticiones recibidas (mÃ©todo, URL, Content-Type)
- âŒ Errores con stack trace
- ğŸ’¾ Operaciones de base de datos
- â˜ï¸ Uploads a Cloudinary

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CONTACTO Y SOPORTE
==================

Para problemas adicionales:
1. Revisar logs del servidor en la consola
2. Verificar que todas las dependencias estÃ©n instaladas: npm install
3. Comprobar que el archivo .env tiene todas las variables necesarias
4. Usar herramientas como Postman para probar endpoints directamente

Archivos importantes para verificar:
- main.js: ConfiguraciÃ³n principal del servidor
- .env: Variables de entorno
- package.json: Dependencias del proyecto

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                                    FIN DE LA DOCUMENTACIÃ“N
                                    
                            Para mÃ¡s informaciÃ³n tÃ©cnica especÃ­fica,
                            revisar el cÃ³digo fuente en cada archivo.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
